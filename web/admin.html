<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Deteccion de Placas - Administracion</title>
    <link rel="stylesheet" href="{{ url_for('static', path='admin.css') }}">
    <style>
        /* Estilos del modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: #fff;
            width: 300px;
            margin: 15% auto;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            text-align: center;
            }
        
        .modal-content p {
            margin-bottom: 20px;
        }
        
        .modal-content button {
            margin: 0 10px;
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
            /* Estilos adicionales para la imagen agrandada */
        .plate-image-enlarged {
            max-width: 90vw; /* Ancho máximo para la imagen agrandada */
            max-height: 90vh; /* Altura máxima para la imagen agrandada */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001; /* Asegura que la imagen esté sobre el modal */
        }
    </style>
</head>
    <body>
    <div class="admin-container">
        <div class="admin-box" style="background-color: #191f2f;">
        <div class="admin-header" style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <h1 style="color: #fff;">Administracion</h1>
            <div class="button-container" style="display: flex; gap: 10px;">
                <button id="runTestIn" style="background-color: #00d072; color: black; font-weight: bold; border: 2px solid #191f2f ; padding: 7px 10px; border-radius: 10px;">Test-E</button>
                <button id="runTestOut" style="background-color: #00d072; color: black; font-weight: bold; border: 2px solid #191f2f ; padding: 7px 10px; border-radius: 10px;">Test-S</button>
                <button id="runSystemIn" style="background-color: #00d072; color: black; font-weight: bold; border: 2px solid #191f2f ; padding: 7px 10px; border-radius: 10px;">Sistema-E</button>
                <button id="runSystemOut" style="background-color: #00d072; color: black; font-weight: bold; border: 2px solid #191f2f ; padding: 7px 10px; border-radius: 10px;">Sistema-S</button>
                <button id="logoutButton" style="background-color: #00d072; color: black; font-weight: bold; border: 2px solid #191f2f ; padding: 7px 10px; border-radius: 10px;">Cerrar Sesion</button>
            </div>
        </div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar placa..." style="width: 770px;">
            <button id="refreshButton" style="margin-top: 10px; background-color: #00d072; color: black; font-weight: bold; border: 2px solid #191f2f; padding: 7px 10px; border-radius: 10px;">Refresh</button>
        </div>
        <div id="plate-list"></div>
        </div>
    </div>
    <!-- Modal HTML -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <p>¿Estas seguro de cerrar sesion?</p>
            <div>
                <button id="noButton">No</button>
                <button id="yesButton">Si</button>
            </div>
        </div>
    </div>
    <script>
        // Función para formatear la fecha
        function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
        return date.toLocaleDateString('es-ES', options);
        }

        function loadPlateData() {
            fetch('http://127.0.0.1:8000/proyecto-c/login/success')
            .then(response => response.json())
            .then(data => {
            const container = document.getElementById('plate-list');
            function renderPlateData(plates) {
                container.innerHTML = ""; // Limpiar el contenedor antes de agregar nuevos elementos
                plates.forEach(plate => {
                    const plateItem = document.createElement("div");
                    plateItem.classList.add("plate-item");
                    plateItem.style.marginBottom = "15px";
                    const plateImageContainer = document.createElement("div");
                    plateImageContainer.classList.add("plate-image");
                    const plateImage = document.createElement("img");
                    plateImage.src = `{{ url_for('static', path='imgs/${plate.ruta_imagen}') }}`;
                    plateImage.alt = plate.ruta_imagen;
                    // Agregar evento de clic a la imagen para agrandarla
                    plateImage.onclick = function() {
                        plateImage.classList.toggle("plate-image-enlarged");
                    };
                    plateImageContainer.appendChild(plateImage);
                    const plateDetails = document.createElement("div");
                    plateDetails.classList.add("plate-details");
                    const plateNumber = document.createElement("h3");
                    plateNumber.textContent = `Placa: ${plate.matricula}`;
                    const entryDate = document.createElement("p");
                    entryDate.textContent = `Fecha de entrada: ${formatDate(plate.fecha_hora_entrada)}`;
                    const outDate = document.createElement("p");
                    outDate.textContent = `Fecha de salida: ${formatDate(plate.fecha_hora_salida)}`;
                    const inParking = document.createElement("p");
                    inParking.textContent = `Dentro de estacionamiento: ${plate.dentro_de_estacionamiento}`;
                    plateDetails.appendChild(plateNumber);
                    plateDetails.appendChild(entryDate);
                    plateDetails.appendChild(outDate);
                    plateDetails.appendChild(inParking);
                    plateItem.appendChild(plateImageContainer);
                    plateItem.appendChild(plateDetails);
                    container.appendChild(plateItem);
                });
            }
            document.getElementById('searchInput').addEventListener('input', function(event) {
                const searchTerm = event.target.value.trim().toLowerCase();
                const filteredPlates = data.filter(plate => plate.matricula.toLowerCase().includes(searchTerm));
                renderPlateData(filteredPlates);
            });
            renderPlateData(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
        }

    document.addEventListener('DOMContentLoaded', function() {
        const logoutButton = document.getElementById('logoutButton');
        const modal = document.getElementById('myModal');
        const noButton = document.getElementById('noButton');
        const yesButton = document.getElementById('yesButton');
        logoutButton.addEventListener('click', function() {
            modal.style.display = 'block'; // Mostrar el modal al hacer clic en "Cerrar Sesion"
        });
        noButton.addEventListener('click', function() {
            modal.style.display = 'none'; // Ocultar el modal al hacer clic en "No"
        });
        yesButton.addEventListener('click', function() {
            window.location.href = '/proyecto-c/login/success/logout'; // Redirigir al hacer clic en "Si"
        });
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none'; // Ocultar el modal al hacer clic fuera de el
            }
        });

        // Agregar evento al boton de refresco
        document.getElementById('refreshButton').addEventListener('click', function() {
            loadPlateData(); // Cargar datos de matriculas al hacer clic en el boton de refresco
        });

        //Funcionalidad para ejecutar el test de entrada
        const runTestIn = document.getElementById('runTestIn');
        runTestIn.addEventListener('click', function() {
            fetch('/proyecto-c/login/success/runTestIn')
            .then(response => {
                if(response.ok) {
                    alert('El programa se ha ejecutado con exito')
                } else {
                    alert('Error al ejecutar el programa')
                }
            })
            .catch(error => {
                console.error('Error: ', error);
                alert('Error al ejecutar el programa');
            });
        });

        //Funcionalidad para ejecutar el test de salida
        const runTestOut = document.getElementById('runTestOut');
        runTestOut.addEventListener('click', function() {
            fetch('/proyecto-c/login/success/runTestOut')
            .then(response => {
                if(response.ok) {
                    alert('El programa se ha ejecutado con exito')
                } else {
                    alert('Error al ejecutar el programa')
                }
            })
            .catch(error => {
                console.error('Error: ', error);
                alert('Error al ejecutar el programa');
            });
        });
        //Funcionalidad para ejecutar el sistema de entrada
        const runSystemIn = document.getElementById('runSystemIn');
        runSystemIn.addEventListener('click', function() {
            fetch('/proyecto-c/login/success/runSystemIn')
            .then(response => {
                if(response.ok) {
                    alert('El programa se ha ejecutado con exito')
                } else {
                    alert('Error al ejecutar el programa')
                }
            })
            .catch(error => {
                console.error('Error: ', error);
                alert('Error al ejecutar el programa');
            });
        });
        //Funcionalidad para ejecutar el sistema de salida
        const runSystemOut = document.getElementById('runSystemOut');
        runSystemOut.addEventListener('click', function() {
            fetch('/proyecto-c/login/success/runSystemOut')
            .then(response => {
                if(response.ok) {
                    alert('El programa se ha ejecutado con exito')
                } else {
                    alert('Error al ejecutar el programa')
                }
            })
            .catch(error => {
                console.error('Error: ', error);
                alert('Error al ejecutar el programa');
            });
        });
    });
    </script>
</body>
</html>